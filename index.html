<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TechPoov Tools â€“ Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared layout styles -->
  <link rel="stylesheet" href="css/site.css">

  <!-- Page-specific styles -->
  <style>
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }

    .card h2 {
      margin-top: 0;
      font-size: 18px;
    }
  </style>
</head>

<body data-page="home">
  <!-- HEADER -->
  <div id="tp-header-container"></div>

  <!-- MAIN WRAPPER -->
  <div class="main-wrapper">
    <div class="layout">

      <!-- SIDEBAR -->
      <div id="sidebar-container"></div>

      <!-- HOME CONTENT -->
      <main class="content">
        <div class="card">
          <h2>Available Tools</h2>
          <div id="home-tool-cards" class="tool-card-grid">
            <!-- cards injected here -->
          </div>
        </div>
      </main>
    </div>
  </div>

    <!-- newly added 2025-12-13-->
  <script src="../js/site-config.js"></script>
  <script src="js/sidebar-tools.js"></script>
<script>
  // ----- Load header & sidebar -----
  function loadPartial(id, url, onLoaded) {
    const el = document.getElementById(id);
    if (!el) return;
    fetch(url)
      .then(r => {
        if (!r.ok) throw new Error('Failed to load ' + url);
        return r.text();
      })
      .then(html => {
        el.innerHTML = html;
        if (typeof onLoaded === 'function') onLoaded();
      })
      .catch(err => console.error(err));
  }

  document.addEventListener('DOMContentLoaded', function () {
    loadPartial('tp-header-container', 'partials/header.html');

    loadPartial('sidebar-container', 'partials/sidebar.html', () => {
      // highlight HOME
      const page = document.body.dataset.page || 'home';
      const selector = '.sidebar-nav .nav-link[data-page="' + page + '"]';
      const active = document.querySelector(selector);
      if (active) active.classList.add('active');

      // Fill TOOLS list in sidebar using shared helper
      tpInitSidebarTools({
        configUrl: 'data/tools-index.txt',      // from root
        basePath: 'pages/tool-readme.html',     // README page
        currentTool: null
      });
    });

    initHomeDashboard();
  });

  // ----- Config & helpers -----

  const HOME_CONFIG_URL = 'data/tools-index.txt';

  function createLink(url, label) {
    if (!url) return '';
    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${label}</a>`;
  }

  // ----- GitHub download count -----

  async function fetchTotalDownloads(repoSlug) {
    const url = `https://api.github.com/repos/${repoSlug}/releases`;
    const response = await fetch(url);
    if (!response.ok) {
      console.warn('GitHub API failed for', repoSlug, response.status);
      return null;
    }

    const releases = await response.json();
    let total = 0;

    releases.forEach(rel => {
      if (Array.isArray(rel.assets)) {
        rel.assets.forEach(asset => {
          if (typeof asset.download_count === 'number') {
            total += asset.download_count;
          }
        });
      }
    });

    return total;
  }

  async function updateAllBadges() {
      if (!SITE_CONFIG.SHOW_DOWNLOAD_COUNT) {
    return Promise.resolve(); // â† graceful no-op
  }
    const badges = document.querySelectorAll('.download-badge[data-repo]');
    for (const badge of badges) {
      const repo = badge.getAttribute('data-repo');
      const valueSpan = badge.querySelector('.download-badge-value');
      const count = await fetchTotalDownloads(repo);
      valueSpan.textContent = count ?? 'â€“';
    }
  }

  // ----- Home dashboard renderer -----
function renderHomeCards(items) {
  const container = document.getElementById('home-tool-cards');
  if (!container) return;
  container.innerHTML = '';

  // From index.html we need to go to /pages/tool-readme.html
  const basePath = 'pages/tool-readme.html';

  items.forEach(item => {
    const rawName = item.ToolName || item.Section || '';
    const displayName = tpGetDisplayName(rawName);   // using shared helper
    const description = item.Description || item.Purpose || '';

    const downloadLink = createLink(item.DownloadURL, 'Download');
    const featureLink = createLink(item.FeatureComparisonURL, 'Feature Comparison');

    const links = [downloadLink, featureLink]
      .filter(Boolean)
      .join(' | ');

    const repoSlug = `TechPoov/${rawName}`;

    const card = document.createElement('div');
    card.className = 'tool-card';
    card.innerHTML = `
      <h3>${displayName}</h3>
      <p>${description}</p>
      <div class="download-badge" data-repo="${repoSlug}">
        <span class="download-badge-label">downloads</span>
        <span class="download-badge-value">â€“</span>
      </div>
      <div class="tool-card-links">
        ${links}
      </div>
    `;

    // ðŸ”¹ On card click: go to that tool's README (inside our layout)
    card.addEventListener('click', (e) => {
      // If user actually clicked a link (Download / Feature Comparison),
      // let that link work normally and do NOT navigate to README.
      if (e.target.tagName === 'A') return;

      const url = `${basePath}?tool=${encodeURIComponent(rawName)}`;
      window.location.href = url;
    });

    container.appendChild(card);
  });
}
function applyDownloadVisibility() {
  if (SITE_CONFIG.SHOW_DOWNLOAD_COUNT) return;

  document.querySelectorAll('.download-badge, .download-count')
    .forEach(el => el.style.display = 'none');
}



  function renderHomeCards_2b_Deleted(items) {
    const container = document.getElementById('home-tool-cards');
    if (!container) return;
    container.innerHTML = '';

    items.forEach(item => {
      const rawName = item.ToolName || item.Section || '';
      const displayName = tpGetDisplayName(rawName);          // shared helper
      const description = item.Description || item.Purpose || '';

      const downloadLink = createLink(item.DownloadURL, 'Download');
      const featureLink = createLink(item.FeatureComparisonURL, 'Feature Comparison');

      const links = [downloadLink, featureLink]
        .filter(Boolean)
        .join(' | ');

      const repoSlug = `TechPoov/${rawName}`;

      const card = document.createElement('div');
      card.className = 'tool-card';
      card.innerHTML = `
        <h3>${displayName}</h3>
        <p>${description}</p>
        <div class="download-badge" data-repo="${repoSlug}">
          <span class="download-badge-label">downloads</span>
          <span class="download-badge-value">â€“</span>
        </div>
        <div class="tool-card-links">
          ${links}
        </div>
      `;
      container.appendChild(card);
    });
  }

  function initHomeDashboard() {
    fetch(HOME_CONFIG_URL)
      .then(r => {
        if (!r.ok) {
          throw new Error('HTTP ' + r.status + ' when fetching ' + HOME_CONFIG_URL);
        }
        return r.text();
      })
      .then(text => {
        const items = tpParseToolsConfig(text);    // shared parser
        renderHomeCards(items);
        applyDownloadVisibility(); 
        return updateAllBadges();
      })
      .catch(err => {
        console.error('Home dashboard error:', err);
      });
  }
</script>

</body>
</html>
